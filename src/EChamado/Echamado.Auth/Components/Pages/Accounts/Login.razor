@page "/Account/Login"
@using Echamado.Auth.Models
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using System.ComponentModel.DataAnnotations

<PageTitle>Login - EChamado</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Class="pa-6" Elevation="3">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6">Login</MudText>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@ErrorMessage</MudAlert>
        }

        <form method="post" action="/Account/DoLogin">
            <input type="hidden" name="returnUrl" value="@ReturnUrl" />

            <MudTextField T="string"
                          name="email"
                          Label="Email"
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="Email is required!"
                          Class="mb-4" />

            <MudTextField T="string"
                          name="password"
                          Label="Password"
                          Variant="Variant.Outlined"
                          InputType="InputType.Password"
                          Required="true"
                          RequiredError="Password is required!"
                          Class="mb-4" />

            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Size="Size.Large">
                Log In
            </MudButton>
        </form>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-4">
            Don't have an account? <MudLink Href="/Account/Register">Register</MudLink>
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    [SupplyParameterFromQuery(Name = "error")]
    public string? ErrorMessage { get; set; }

    [SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    [Inject] NavigationManager Navigation { get; set; } = default!;

    protected override void OnParametersSet()
    {
        if (string.IsNullOrEmpty(ReturnUrl))
        {
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);
            if (query.TryGetValue("ReturnUrl", out var upper) && upper.Count > 0)
            {
                ReturnUrl = upper[0];
            }
        }
    }
}
