<!DOCTYPE html>
<html>
<head>
    <title>OAuth PKCE Flow Test</title>
    <script>
        // Test OAuth PKCE Flow
        const authServer = 'http://localhost:7132';
        const clientId = 'bwa-client';
        const redirectUri = 'http://localhost:7274/authentication/login-callback';
        const scope = 'openid profile email roles api chamados';

        function log(message, isError = false) {
            const timestamp = new Date().toISOString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.style.color = isError ? 'red' : 'black';
            logEntry.textContent = logMessage;
            logsDiv.appendChild(logEntry);
        }

        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let text = '';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        function base64urlencode(a) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return await crypto.subtle.digest('SHA-256', data);
        }

        async function testOAuthFlow() {
            try {
                log('ğŸ”„ Starting OAuth PKCE Flow Test');

                // Step 1: Generate PKCE parameters
                log('ğŸ“ Step 1: Generating PKCE parameters');
                const codeVerifier = generateRandomString(128);
                log(`âœ“ Code verifier generated: ${codeVerifier.substring(0, 20)}...`);

                const codeChallenge = base64urlencode(await sha256(codeVerifier));
                log(`âœ“ Code challenge generated: ${codeChallenge.substring(0, 20)}...`);

                // Step 2: Generate state parameter
                const state = generateRandomString(32);
                log(`âœ“ State parameter generated: ${state}`);

                // Step 3: Build authorization URL
                const authUrl = `${authServer}/connect/authorize?` +
                    `client_id=${encodeURIComponent(clientId)}&` +
                    `response_type=code&` +
                    `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                    `scope=${encodeURIComponent(scope)}&` +
                    `code_challenge=${encodeURIComponent(codeChallenge)}&` +
                    `code_challenge_method=S256&` +
                    `state=${encodeURIComponent(state)}`;

                log(`ğŸ“¤ Step 2: Authorization URL built: ${authUrl}`);

                // Step 4: Simulate token exchange
                log('ğŸ”„ Step 4: Simulating token exchange (this would normally be done after OAuth redirect)');
                
                // This is what the client would do after receiving the 'code' from OAuth redirect
                const tokenResponse = await fetch(`${authServer}/connect/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'grant_type': 'authorization_code',
                        'client_id': clientId,
                        'code_verifier': codeVerifier,
                        'code': 'dummy_code', // This would be the real code from OAuth redirect
                        'redirect_uri': redirectUri
                    })
                });

                const tokenData = await tokenResponse.json();
                log(`ğŸ“¥ Token response: ${JSON.stringify(tokenData, null, 2)}`);

                if (tokenData.access_token) {
                    log('âœ… SUCCESS: Access token received!');
                    
                    // Step 5: Decode and verify token
                    const tokenPayload = JSON.parse(atob(tokenData.access_token.split('.')[1]));
                    log(`ğŸ‘¤ User ID: ${tokenPayload.sub}`);
                    log(`ğŸ“§ Email: ${tokenPayload.email}`);
                    log(`ğŸ¯ Audience: ${tokenPayload.aud}`);
                    
                    // Save token for later testing
                    localStorage.setItem('test_access_token', tokenData.access_token);
                    log('ğŸ’¾ Token saved to localStorage');
                } else {
                    log(`âŒ ERROR: ${tokenData.error || 'Unknown error'}`, true);
                }

            } catch (error) {
                log(`âŒ ERROR: ${error.message}`, true);
                console.error('OAuth flow error:', error);
            }
        }

        function testTokenIntrospection() {
            const token = localStorage.getItem('test_access_token');
            if (!token) {
                log('âŒ No token found. Run OAuth flow first.', true);
                return;
            }

            fetch('http://localhost:7001/api/auth/introspect', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                log(`ğŸ” Token introspection result: ${JSON.stringify(data, null, 2)}`);
            })
            .catch(error => {
                log(`âŒ Token introspection failed: ${error.message}`, true);
            });
        }

        function testAPIWithToken() {
            const token = localStorage.getItem('test_access_token');
            if (!token) {
                log('âŒ No token found. Run OAuth flow first.', true);
                return;
            }

            // Test against our client API
            fetch('http://localhost:7274/', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                log(`ğŸ”— API Response status: ${response.status}`);
                return response.text();
            })
            .then(data => {
                log(`ğŸ”— API Response: ${data.substring(0, 200)}...`);
            })
            .catch(error => {
                log(`âŒ API test failed: ${error.message}`, true);
            });
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            localStorage.removeItem('test_access_token');
            log('ğŸ—‘ï¸ Logs cleared and token removed');
        }
    </script>
</head>
<body>
    <h1>ğŸ” EChamado OAuth PKCE Flow Test</h1>
    
    <div style="margin: 20px 0;">
        <button onclick="testOAuthFlow()" style="margin: 5px; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ğŸ”„ Test OAuth PKCE Flow
        </button>
        
        <button onclick="testTokenIntrospection()" style="margin: 5px; padding: 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ğŸ” Test Token Introspection
        </button>
        
        <button onclick="testAPIWithToken()" style="margin: 5px; padding: 10px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ğŸ”— Test API with Token
        </button>
        
        <button onclick="clearLogs()" style="margin: 5px; padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ğŸ—‘ï¸ Clear Logs
        </button>
    </div>

    <h3>ğŸ“‹ Debug Logs:</h3>
    <div id="logs" style="border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: #f9f9f9; font-family: monospace; font-size: 12px;"></div>

    <div style="margin-top: 20px;">
        <h3>ğŸš€ Current Status:</h3>
        <ul>
            <li>âœ… Auth Server: <strong>Running on http://localhost:7132</strong></li>
            <li>âœ… Client Server: <strong>Running on http://localhost:7274</strong></li>
            <li>ğŸ“ Note: This test simulates the OAuth PKCE flow without browser redirect</li>
            <li>ğŸ”‘ Token will be stored in localStorage for testing</li>
        </ul>
    </div>
</body>
</html>