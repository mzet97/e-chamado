@page "/orders/odata"
@using EChamado.Client.Services
@using EChamado.Client.Models
@inject IODataService ODataService
@inject ILogger<OrderListOData> Logger
@attribute [Authorize]

<PageTitle>Chamados OData - EChamado</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.FilterList" Color="Color.Primary" Size="Size.Large" />
            <MudText Typo="Typo.h4">Chamados com OData</MudText>
        </MudStack>
    </div>

    <MudCard Elevation="3" Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Filtros OData Avan√ßados</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="filterText"
                                 Label="Filtro OData"
                                 Variant="Variant.Outlined"
                                 HelperText="Ex: contains(Title, 'Suporte')" 
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.FilterAlt"/>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="orderByText"
                                 Label="Ordena√ß√£o"
                                 Variant="Variant.Outlined"
                                 HelperText="Ex: CreatedAt desc" 
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Sort"/>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudNumericField @bind-Value="topValue"
                                    Label="Quantidade (Top)"
                                    Variant="Variant.Outlined"
                                    Min="1"
                                    Max="100" 
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Filled.FormatListNumbered"/>
                </MudItem>
            </MudGrid>

            <MudGrid Class="mt-2">
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Filtros R√°pidos:</MudText>
                    <MudChipSet T="string">
                        <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" OnClick="@(() => ApplyQuickFilter("contains(Title, 'Suporte')"))">
                            T√≠tulo cont√©m "Suporte"
                        </MudChip>
                        <MudChip T="string" Color="Color.Secondary" Variant="Variant.Outlined" OnClick="@(() => ApplyQuickFilter("IsDeleted eq false"))">
                            N√£o deletados
                        </MudChip>
                        <MudChip T="string" Color="Color.Tertiary" Variant="Variant.Outlined" OnClick="@(() => ApplyQuickFilter("CreatedAt ge 2024-01-01"))">
                            Criados em 2024+
                        </MudChip>
                        <MudChip T="string" Color="Color.Info" Variant="Variant.Outlined" OnClick="@(() => ApplyOrderBy("CreatedAt desc"))">
                            Mais recentes primeiro
                        </MudChip>
                        <MudChip T="string" Color="Color.Default" Variant="Variant.Filled" OnClick="ClearFilters" Icon="@Icons.Material.Filled.Clear">
                            Limpar filtros
                        </MudChip>
                    </MudChipSet>
                </MudItem>
            </MudGrid>
        </MudCardContent>
        <MudCardActions Class="pa-4 justify-end">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       Class="mr-2"
                       OnClick="LoadCountAsync"
                       Disabled="loading"
                       StartIcon="@Icons.Material.Filled.Calculate">
                Contar Total
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="LoadOrdersAsync"
                       Disabled="loading"
                       StartIcon="@Icons.Material.Filled.Search">
                @if (loading)
                {
                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                    <span>Carregando...</span>
                }
                else
                {
                    <span>Buscar Orders</span>
                }
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" Elevation="3">@errorMessage</MudAlert>
    }

    @if (totalCount.HasValue)
    {
        <MudAlert Severity="Severity.Info" Class="mb-4" Elevation="3" Icon="@Icons.Material.Filled.Info">
            Total de orders (com filtro aplicado): <strong>@totalCount</strong>
        </MudAlert>
    }

    @if (orders != null && orders.Any())
    {
        <MudCard Elevation="3">
            <MudCardContent Class="pa-0">
                <MudTable Items="@orders" Hover="true" Striped="true" Dense="true" Elevation="0">
                    <HeaderContent>
                        <MudTh>T√≠tulo</MudTh>
                        <MudTh>Descri√ß√£o</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Tipo</MudTh>
                        <MudTh>Categoria</MudTh>
                        <MudTh>Departamento</MudTh>
                        <MudTh>Data Abertura</MudTh>
                        <MudTh>Solicitante</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="T√≠tulo"><b>@context.Title</b></MudTd>
                        <MudTd DataLabel="Descri√ß√£o">
                            <MudText Typo="Typo.body2" Style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                -
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary">@context.StatusName</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Tipo">@context.TypeName</MudTd>
                        <MudTd DataLabel="Categoria">-</MudTd>
                        <MudTd DataLabel="Departamento">@context.DepartmentName</MudTd>
                        <MudTd DataLabel="Data Abertura">@context.OpeningDate.ToString("dd/MM/yyyy HH:mm")</MudTd>
                        <MudTd DataLabel="Solicitante">@context.RequestingUserEmail</MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </MudCardContent>
        </MudCard>

        <MudText Typo="Typo.caption" Class="mt-2 pl-1">
            Exibindo @orders.Count() order(s) carregadas via OData
        </MudText>
    }
    else if (!loading && orders != null)
    {
        <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Elevation="3">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" Class="mb-4" style="width: 64px; height: 64px;" />
            <MudText Typo="Typo.h6" Color="Color.Secondary">Nenhum chamado encontrado</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Tente ajustar seus filtros OData.</MudText>
        </MudPaper>
    }

    <MudExpansionPanels Class="mt-4" Elevation="3">
        <MudExpansionPanel Text="üìö Exemplos de Queries OData" Icon="@Icons.Material.Filled.HelpOutline">
            <MudList T="string" Dense="true">
                <MudListItem T="string" Icon="@Icons.Material.Filled.Code">
                    <code>contains(Title, 'Suporte')</code> - T√≠tulo cont√©m "Suporte"
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.Code">
                    <code>StatusName eq 'Aberto'</code> - Status igual a "Aberto"
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.Code">
                    <code>CreatedAt ge 2024-01-01</code> - Criados ap√≥s 01/01/2024
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.Code">
                    <code>IsDeleted eq false and contains(Title, 'TI')</code> - N√£o deletados E t√≠tulo cont√©m "TI"
                </MudListItem>
                <MudListItem T="string" Icon="@Icons.Material.Filled.Code">
                    <code>CreatedAt desc</code> - Ordenar por data de cria√ß√£o (descendente)
                </MudListItem>
            </MudList>
        </MudExpansionPanel>
    </MudExpansionPanels>
</MudContainer>

@code {
    private IEnumerable<OrderListViewModel>? orders;
    private string? filterText;
    private string? orderByText;
    private int? topValue = 20;
    private int? totalCount;
    private bool loading = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrdersAsync();
    }

    private async Task LoadOrdersAsync()
    {
        loading = true;
        errorMessage = null;
        totalCount = null;

        try
        {
            orders = await ODataService.GetOrdersAsync(
                filter: filterText,
                orderBy: orderByText,
                top: topValue
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading orders via OData");
            errorMessage = $"Erro ao carregar orders: {ex.Message}";
            orders = null;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadCountAsync()
    {
        loading = true;
        errorMessage = null;

        try
        {
            totalCount = await ODataService.GetOrdersCountAsync(filterText);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error counting orders via OData");
            errorMessage = $"Erro ao contar orders: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private void ApplyQuickFilter(string filter)
    {
        filterText = filter;
    }

    private void ApplyOrderBy(string orderBy)
    {
        orderByText = orderBy;
    }

    private void ClearFilters()
    {
        filterText = null;
        orderByText = null;
        topValue = 20;
        totalCount = null;
    }
}
