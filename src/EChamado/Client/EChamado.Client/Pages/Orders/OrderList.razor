@page "/orders"
@using EChamado.Client.Services
@using EChamado.Client.Models
@using System.Reflection
@inject OrderService OrderService
@inject LookupService LookupService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@attribute [Authorize]

<PageTitle>Chamados - EChamado</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">Chamados</MudText>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   Href="/orders/create">
            Novo Chamado
        </MudButton>
    </div>

    <!-- Filtros -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">Filtros</MudText>
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudTextField @bind-Value="searchText"
                              Label="Buscar"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="false"
                              OnKeyUp="@(args => { if (args.Key == "Enter") ApplyFilters(); })" />
            </MudItem>

            <MudItem xs="12" md="3">
                <MudSelect T="Guid?" @bind-Value="selectedStatus"
                           Label="Status"
                           Variant="Variant.Outlined"
                           Clearable="true">
                    @foreach (var status in statuses)
                    {
                        <MudSelectItem T="Guid?" Value="@status.Id">@status.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="3">
                <MudSelect T="Guid?" @bind-Value="selectedDepartment"
                           Label="Departamento"
                           Variant="Variant.Outlined"
                           Clearable="true">
                    @foreach (var dept in departments)
                    {
                        <MudSelectItem T="Guid?" Value="@dept.Id">@dept.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="3">
                <MudSelect T="Guid?" @bind-Value="selectedType"
                           Label="Tipo"
                           Variant="Variant.Outlined"
                           Clearable="true">
                    @foreach (var type in types)
                    {
                        <MudSelectItem T="Guid?" Value="@type.Id">@type.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudDateRangePicker @bind-DateRange="dateRange"
                                    Label="Período"
                                    Variant="Variant.Outlined"
                                    Clearable="true" />
            </MudItem>

            <MudItem xs="12" md="3">
                <MudSwitch T="bool" @bind-Checked="showOnlyOverdue"
                           Color="Color.Error"
                           Label="Somente Vencidos" />
            </MudItem>

            <MudItem xs="12" md="3" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           OnClick="ApplyFilters">
                    Filtrar
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Tabela -->
    <MudDataGrid T="OrderListViewModel"
                 ServerData="LoadOrders"
                 Filterable="true"
                 Sortable="true"
                 Hover="true"
                 Dense="false"
                 Striped="true"
                 Bordered="true"
                 @ref="grid"
                 Loading="@isLoading"
                 QuickFilter="@QuickFilter"
                 PageSizeOptions="@(new int[] { 10, 20, 50 })">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Lista de Chamados</MudText>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Color="Color.Primary"
                           OnClick="@(() => grid.ReloadServerData())" />
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.Title" Title="Título" Sortable="true" Filterable="true" />
            <TemplateColumn Title="Status" Sortable="true" Filterable="true">
                <CellTemplate>
                    <MudChip T="string" Size="Size.Small" Color="GetStatusColor(context.Item.StatusName)">
                        @context.Item.StatusName
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.TypeName" Title="Tipo" Sortable="true" Filterable="true" />
            <PropertyColumn Property="x => x.DepartmentName" Title="Departamento" Sortable="true" Filterable="true" />
            <PropertyColumn Property="x => x.RequestingUserEmail" Title="Solicitante" Sortable="true" Filterable="true" />
            <TemplateColumn Title="Data Abertura" Sortable="true" Filterable="true" Property="x => x.OpeningDate">
                <CellTemplate>
                    <MudText>@context.Item.OpeningDate.ToString("dd/MM/yyyy")</MudText>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Prazo" Sortable="true" Filterable="true" Property="x => x.DueDate">
                <CellTemplate>
                    @if (context.Item.IsOverdue)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error">Vencido</MudChip>
                    }
                    else if (context.Item.DueDate.HasValue)
                    {
                        <MudText>@context.Item.DueDate.Value.ToString("dd/MM/yyyy")</MudText>
                    }
                    else
                    {
                        <MudText>-</MudText>
                    }
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Ações" CellClass="d-flex align-center" Align="MudBlazor.Align.Right" Sortable="false" Filterable="false">
                <CellTemplate>
                    <MudTooltip Text="Ver Detalhes">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       Href="@($"/orders/{context.Item.Id}")" />
                    </MudTooltip>
                    <MudTooltip Text="Editar">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Size="Size.Small"
                                       Color="Color.Info"
                                       Href="@($"/orders/{context.Item.Id}/edit")" />
                    </MudTooltip>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="OrderListViewModel" />
        </PagerContent>
        <NoRecordsContent>
            <MudText>Nenhum chamado encontrado</MudText>
        </NoRecordsContent>
    </MudDataGrid>
</MudContainer>

@code {
    private MudDataGrid<OrderListViewModel> grid = null!;
    private bool isLoading;

    // Filtros
    private string searchText = string.Empty;
    private Guid? selectedStatus;
    private Guid? selectedDepartment;
    private Guid? selectedType;
    private DateRange? dateRange;
    private bool showOnlyOverdue;

    // Lookups
    private List<StatusTypeResponse> statuses = new();
    private List<DepartmentResponse> departments = new();
    private List<OrderTypeResponse> types = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Carrega lookups em paralelo
            var statusTask = LookupService.GetStatusTypesAsync();
            var deptTask = LookupService.GetDepartmentsAsync();
            var typeTask = LookupService.GetOrderTypesAsync();

            await Task.WhenAll(statusTask, deptTask, typeTask);

            statuses = await statusTask;
            departments = await deptTask;
            types = await typeTask;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar filtros: {ex.Message}", Severity.Error);
        }
    }

    private async Task<GridData<OrderListViewModel>> LoadOrders(GridState<OrderListViewModel> state)
    {
        isLoading = true;

        try
        {
            DateTime? startDate = dateRange?.Start?.Date;
            DateTime? endDate = dateRange?.End?.Date;

            if (endDate.HasValue)
                endDate = endDate.Value.AddDays(1).AddTicks(-1);

            var parameters = new SearchOrdersParameters
            {
                PageIndex = state.Page + 1,
                PageSize = state.PageSize,
                Title = string.IsNullOrWhiteSpace(searchText) ? null : searchText,
                StatusTypeId = selectedStatus,
                DepartmentId = selectedDepartment,
                TypeId = selectedType,
                StartDate = startDate,
                EndDate = endDate,
                IsOverdue = showOnlyOverdue ? true : null
            };

            var result = await OrderService.SearchAsync(parameters);

            var ordered = ApplySorting(result.Items, state);

            return new GridData<OrderListViewModel>
            {
                TotalItems = result.TotalCount,
                Items = ordered.ToList()
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar chamados: {ex.Message}", Severity.Error);
            return new GridData<OrderListViewModel> { TotalItems = 0, Items = new List<OrderListViewModel>() };
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        grid?.ReloadServerData();
    }

    private IEnumerable<OrderListViewModel> ApplySorting(IEnumerable<OrderListViewModel> items, GridState<OrderListViewModel> state)
    {
        if (state.SortDefinitions == null || state.SortDefinitions.Count == 0)
            return items;

        IOrderedEnumerable<OrderListViewModel>? orderedItems = null;

        foreach (var sort in state.SortDefinitions)
        {
            var propertyName = sort.SortBy;
            if (string.IsNullOrWhiteSpace(propertyName))
                continue;

            var prop = typeof(OrderListViewModel).GetProperty(propertyName, BindingFlags.IgnoreCase | BindingFlags.Public | BindingFlags.Instance);
            if (prop is null)
                continue;

            Func<OrderListViewModel, object?> keySelector = item => prop.GetValue(item);

            orderedItems = sort.Descending
                ? (orderedItems == null ? items.OrderByDescending(keySelector) : orderedItems.ThenByDescending(keySelector))
                : (orderedItems == null ? items.OrderBy(keySelector) : orderedItems.ThenBy(keySelector));
        }

        return orderedItems ?? items;
    }

    private Func<OrderListViewModel, bool> QuickFilter => order =>
    {
        if (string.IsNullOrWhiteSpace(searchText))
            return true;

        var term = searchText.ToLower();
        return order.Title.ToLower().Contains(term)
               || order.StatusName.ToLower().Contains(term)
               || order.TypeName.ToLower().Contains(term)
               || (order.DepartmentName?.ToLower().Contains(term) ?? false)
               || order.RequestingUserEmail.ToLower().Contains(term);
    };

    private Color GetStatusColor(string status) => status.ToLower() switch
    {
        var s when s.Contains("aberto") || s.Contains("open") => Color.Info,
        var s when s.Contains("andamento") || s.Contains("progress") => Color.Warning,
        var s when s.Contains("fechado") || s.Contains("closed") || s.Contains("resolvido") => Color.Success,
        _ => Color.Default
    };
}
