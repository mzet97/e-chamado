@page "/orders"
@using EChamado.Client.Services
@using EChamado.Client.Models
@using EChamado.Client.Components
@using System.Reflection
@using MudBlazor.Services
@inject IBrowserViewportService BrowserViewportService
@implements IBrowserViewportObserver
@inject OrderService OrderService
@inject IODataService ODataService
@inject INLQueryService NLQueryService
@inject LookupService LookupService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject ILogger<OrderList> Logger
@attribute [Authorize]

<PageTitle>Chamados - EChamado</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">Chamados</MudText>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   Href="/orders/create">
            Novo Chamado
        </MudButton>
    </div>

    <!-- AI Natural Language Query Component -->
    <NLQueryInput EntityName="Order"
                  OnQueryGenerated="HandleAIQueryGenerated" />

    <!-- Filtros -->
    <MudExpansionPanels Class="mb-4" Elevation="2">
        <MudExpansionPanel Text="Filtros e Pesquisa" IsExpanded="@(_isFilterExpanded)">
            <TitleContent>
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.FilterList" Class="mr-3" Color="Color.Primary"/>
                    <MudText Typo="Typo.h6">Filtros</MudText>
                    @if (ActiveFiltersCount > 0)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="ml-4">@ActiveFiltersCount ativos</MudChip>
                    }
                </div>
            </TitleContent>
            <ChildContent>
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudTextField @bind-Value="searchText"
                                      Label="Buscar"
                                      Placeholder="Título, email..."
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      Immediate="false"
                                      OnKeyUp="@(args => { if (args.Key == "Enter") ApplyFilters(); })" />
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3">
                        <MudSelect T="Guid?" @bind-Value="selectedStatus"
                                   Label="Status"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var status in statuses)
                            {
                                <MudSelectItem T="Guid?" Value="@status.Id">@status.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3">
                        <MudSelect T="Guid?" @bind-Value="selectedDepartment"
                                   Label="Departamento"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var dept in departments)
                            {
                                <MudSelectItem T="Guid?" Value="@dept.Id">@dept.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3">
                        <MudSelect T="Guid?" @bind-Value="selectedType"
                                   Label="Tipo"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var type in types)
                            {
                                <MudSelectItem T="Guid?" Value="@type.Id">@type.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudDateRangePicker @bind-DateRange="dateRange"
                                            Label="Período"
                                            Variant="Variant.Outlined"
                                            Clearable="true" />
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3" Class="d-flex align-center">
                         <MudSwitch T="bool" @bind-Checked="showOnlyOverdue"
                                   Color="Color.Error"
                                   Label="Somente Vencidos" />
                    </MudItem>

                    <MudItem xs="12" sm="6" md="3" Class="d-flex align-center gap-2">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   OnClick="ApplyFilters"
                                   StartIcon="@Icons.Material.Filled.FilterList">
                            Filtrar
                        </MudButton>
                         <MudButton Variant="Variant.Outlined"
                                   Color="Color.Secondary"
                                   OnClick="ClearFilters"
                                   StartIcon="@Icons.Material.Filled.Clear">
                            Limpar
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </ChildContent>
        </MudExpansionPanel>
    </MudExpansionPanels>

    <!-- Tabela -->
    <MudDataGrid T="OrderListViewModel"
                 ServerData="LoadOrders"
                 Filterable="false"
                 Sortable="true"
                 Hover="true"
                 Dense="true"
                 Striped="true"
                 Bordered="false"
                 Elevation="2"
                 @ref="grid"
                 Loading="@isLoading"
                 PageSizeOptions="@(new int[] { 10, 20, 50 })"
                 Class="rounded-lg">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Lista de Chamados</MudText>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Color="Color.Primary"
                           OnClick="@(() => grid.ReloadServerData())" />
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.Title" Title="Título" Sortable="true" />
            
            <TemplateColumn Title="Status" Sortable="true">
                <CellTemplate>
                    <MudChip T="string" Size="Size.Small" Color="GetStatusColor(context.Item.StatusName)" Variant="Variant.Text">
                        @context.Item.StatusName
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>
            
            <PropertyColumn Property="x => x.TypeName" Title="Tipo" Sortable="true" Hidden="@(_isMobile)" />
            
            <PropertyColumn Property="x => x.DepartmentName" Title="Departamento" Sortable="true" Hidden="@(_isMobile)" />
            
            <PropertyColumn Property="x => x.RequestingUserEmail" Title="Solicitante" Sortable="true" Hidden="@(_isMobile)" />
            
            <TemplateColumn Title="Datas" Sortable="true">
                <CellTemplate>
                    <div class="d-flex flex-column">
                        <MudText Typo="Typo.caption">Abertura: @context.Item.OpeningDate.ToString("dd/MM")</MudText>
                         @if (context.Item.DueDate.HasValue)
                        {
                            <MudText Typo="Typo.caption" Color="@(context.Item.IsOverdue ? Color.Error : Color.Default)">
                                Prazo: @context.Item.DueDate.Value.ToString("dd/MM")
                            </MudText>
                        }
                    </div>
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="Ações" CellClass="d-flex align-center justify-end" Sortable="false">
                <CellTemplate>
                    <MudTooltip Text="Ver Detalhes">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       Href="@($"/orders/{context.Item.Id}")" />
                    </MudTooltip>
                    <MudTooltip Text="Editar">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Size="Size.Small"
                                       Color="Color.Info"
                                       Href="@($"/orders/{context.Item.Id}/edit")" />
                    </MudTooltip>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="OrderListViewModel" />
        </PagerContent>
        <NoRecordsContent>
            <div class="d-flex flex-column align-center justify-center py-4">
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
                <MudText Color="Color.Secondary" Class="mt-2">Nenhum chamado encontrado com os filtros atuais</MudText>
            </div>
        </NoRecordsContent>
    </MudDataGrid>
</MudContainer>

@code {
    private MudDataGrid<OrderListViewModel> grid = null!;
    private bool isLoading;
    private string? currentODataFilter;
    
    // UI State
    private bool _isFilterExpanded = true;
    private bool _isMobile;

    // Filtros
    private string searchText = string.Empty;
    private Guid? selectedStatus;
    private Guid? selectedDepartment;
    private Guid? selectedType;
    private DateRange? dateRange;
    private bool showOnlyOverdue;

    private int ActiveFiltersCount
    {
        get
        {
            int count = 0;
            if (!string.IsNullOrWhiteSpace(searchText)) count++;
            if (selectedStatus.HasValue) count++;
            if (selectedDepartment.HasValue) count++;
            if (selectedType.HasValue) count++;
            if (dateRange != null && (dateRange.Start.HasValue || dateRange.End.HasValue)) count++;
            if (showOnlyOverdue) count++;
            return count;
        }
    }

    // Lookups
    private List<StatusTypeResponse> statuses = new();
    private List<DepartmentResponse> departments = new();
    private List<OrderTypeResponse> types = new();

    // IBrowserViewportObserver implementation
    Guid IBrowserViewportObserver.Id { get; } = Guid.NewGuid();
    
    ResizeOptions IBrowserViewportObserver.ResizeOptions { get; } = new()
    {
        ReportRate = 50,
        NotifyOnBreakpointOnly = true
    };

    Task IBrowserViewportObserver.NotifyBrowserViewportChangeAsync(BrowserViewportEventArgs browserViewportEventArgs)
    {
        _isMobile = browserViewportEventArgs.Breakpoint <= Breakpoint.Sm;
        return InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await BrowserViewportService.SubscribeAsync(this, fireImmediately: true);
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    public async ValueTask DisposeAsync() => await BrowserViewportService.UnsubscribeAsync(this);

    private async Task HandleAIQueryGenerated(string gridifyQuery)
    {
        Logger.LogInformation("AI generated Gridify query for Orders: {Query}", gridifyQuery);

        // Convert Gridify to OData filter (simplified - in production you'd need proper conversion)
        // For now, we'll use it directly as OData filter with some basic conversions
        currentODataFilter = ConvertGridifyToOData(gridifyQuery);

        // Clear other filters when using AI
        ClearFilters(reload: false);

        // Reload grid with AI filter
        await grid.ReloadServerData();
    }

    private string ConvertGridifyToOData(string gridifyQuery)
    {
        // Basic conversion: Gridify uses *= for contains, OData uses contains()
        var odataQuery = gridifyQuery
            .Replace("*=", "contains")
            .Replace("&", "and")
            .Replace("|", "or");

        return odataQuery;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Carrega lookups em paralelo
            var statusTask = LookupService.GetStatusTypesAsync();
            var deptTask = LookupService.GetDepartmentsAsync();
            var typeTask = LookupService.GetOrderTypesAsync();

            await Task.WhenAll(statusTask, deptTask, typeTask);

            statuses = await statusTask;
            departments = await deptTask;
            types = await typeTask;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar filtros: {ex.Message}", Severity.Error);
        }
    }

    private async Task<GridData<OrderListViewModel>> LoadOrders(GridState<OrderListViewModel> state)
    {
        isLoading = true;

        try
        {
            // If AI filter is active, use OData
            if (!string.IsNullOrWhiteSpace(currentODataFilter))
            {
                Logger.LogInformation("Loading orders with OData filter: {Filter}", currentODataFilter);

                var odataOrders = await ODataService.GetOrdersAsync(
                    filter: currentODataFilter,
                    orderBy: "OpeningDate desc",
                    skip: state.Page * state.PageSize,
                    top: state.PageSize
                );

                var ordersList = odataOrders.ToList();

                return new GridData<OrderListViewModel>
                {
                    TotalItems = ordersList.Count, // OData doesn't return total count in this implementation
                    Items = ordersList
                };
            }
            // Otherwise use traditional filters
            else
            {
                DateTime? startDate = dateRange?.Start?.Date;
                DateTime? endDate = dateRange?.End?.Date;

                if (endDate.HasValue)
                    endDate = endDate.Value.AddDays(1).AddTicks(-1);

                var parameters = new SearchOrdersParameters
                {
                    PageIndex = state.Page + 1,
                    PageSize = state.PageSize,
                    Title = string.IsNullOrWhiteSpace(searchText) ? null : searchText,
                    StatusTypeId = selectedStatus,
                    DepartmentId = selectedDepartment,
                    TypeId = selectedType,
                    StartDate = startDate,
                    EndDate = endDate,
                    IsOverdue = showOnlyOverdue ? true : null
                };

                var result = await OrderService.SearchAsync(parameters);

                var ordered = ApplySorting(result.Items, state);

                return new GridData<OrderListViewModel>
                {
                    TotalItems = result.TotalCount,
                    Items = ordered.ToList()
                };
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading orders");
            Snackbar.Add($"Erro ao carregar chamados: {ex.Message}", Severity.Error);
            return new GridData<OrderListViewModel> { TotalItems = 0, Items = new List<OrderListViewModel>() };
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        // Clear AI filter when using traditional filters
        currentODataFilter = null;
        grid?.ReloadServerData();
    }

    private void ClearFilters() => ClearFilters(reload: true);

    private void ClearFilters(bool reload)
    {
        searchText = string.Empty;
        selectedStatus = null;
        selectedDepartment = null;
        selectedType = null;
        dateRange = null;
        showOnlyOverdue = false;
        currentODataFilter = null;
        
        if (reload)
            grid?.ReloadServerData();
    }

    private IEnumerable<OrderListViewModel> ApplySorting(IEnumerable<OrderListViewModel> items, GridState<OrderListViewModel> state)
    {
        if (state.SortDefinitions == null || state.SortDefinitions.Count == 0)
            return items;

        IOrderedEnumerable<OrderListViewModel>? orderedItems = null;

        foreach (var sort in state.SortDefinitions)
        {
            var propertyName = sort.SortBy;
            if (string.IsNullOrWhiteSpace(propertyName))
                continue;

            var prop = typeof(OrderListViewModel).GetProperty(propertyName, BindingFlags.IgnoreCase | BindingFlags.Public | BindingFlags.Instance);
            if (prop is null)
                continue;

            Func<OrderListViewModel, object?> keySelector = item => prop.GetValue(item);

            orderedItems = sort.Descending
                ? (orderedItems == null ? items.OrderByDescending(keySelector) : orderedItems.ThenByDescending(keySelector))
                : (orderedItems == null ? items.OrderBy(keySelector) : orderedItems.ThenBy(keySelector));
        }

        return orderedItems ?? items;
    }

    private Color GetStatusColor(string status) => status.ToLower() switch
    {
        var s when s.Contains("aberto") || s.Contains("open") => Color.Info,
        var s when s.Contains("andamento") || s.Contains("progress") => Color.Warning,
        var s when s.Contains("fechado") || s.Contains("closed") || s.Contains("resolvido") => Color.Success,
        _ => Color.Default
    };
}
