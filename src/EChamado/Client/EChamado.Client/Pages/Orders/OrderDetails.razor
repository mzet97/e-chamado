@page "/orders/{Id:guid}"
@using EChamado.Client.Services
@using EChamado.Client.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject OrderService OrderService
@inject CommentService CommentService
@inject LookupService LookupService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Chamado #@(order?.Id.ToString().Substring(0, 8)) - EChamado</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 mb-8">
    @if (isLoading)
    {
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudSkeleton Height="200px" Class="mb-4" />
                <MudSkeleton Height="300px" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudSkeleton Height="400px" />
            </MudItem>
        </MudGrid>
    }
    else if (order == null)
    {
        <MudAlert Severity="Severity.Error">Chamado não encontrado</MudAlert>
    }
    else
    {
        <!-- Header -->
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <div>
                <MudText Typo="Typo.h4">@order.Title</MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                     <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Secondary" />
                     <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Criado em @order.OpeningDate.ToString("dd/MM/yyyy HH:mm")
                    </MudText>
                </MudStack>
            </div>
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           Href="/orders">
                    Voltar
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Edit"
                           Href="@($"/orders/{Id}/edit")">
                    Editar
                </MudButton>
            </MudStack>
        </MudStack>

        <MudGrid>
            <!-- Coluna Principal -->
            <MudItem xs="12" md="8">
                <!-- Informações Principais -->
                <MudCard Class="mb-4" Elevation="3">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Descrição</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Style="white-space: pre-wrap;">@order.Description</MudText>
                    </MudCardContent>
                </MudCard>

                <!-- Comentários -->
                <MudCard Elevation="3">
                    <MudCardHeader>
                         <CardHeaderAvatar>
                            <MudIcon Icon="@Icons.Material.Filled.Comment" />
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Comentários</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (order.Comments?.Any() == true)
                        {
                            <MudTimeline TimelinePosition="TimelinePosition.Start">
                                @foreach (var comment in order.Comments.OrderByDescending(c => c.CreatedAt))
                                {
                                    <MudTimelineItem Color="Color.Primary" Size="Size.Small">
                                        <ItemOpposite>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @comment.CreatedAt.ToString("dd/MM HH:mm")
                                            </MudText>
                                        </ItemOpposite>
                                        <ItemContent>
                                            <MudPaper Elevation="0" Class="pa-3 grey lighten-5 rounded">
                                                <MudText Typo="Typo.subtitle2" Class="font-weight-bold">@comment.UserEmail</MudText>
                                                <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@comment.Text</MudText>
                                            </MudPaper>
                                        </ItemContent>
                                    </MudTimelineItem>
                                }
                            </MudTimeline>
                        }
                        else
                        {
                            <div class="d-flex flex-column align-center justify-center py-8">
                                <MudIcon Icon="@Icons.Material.Filled.ChatBubbleOutline" Size="Size.Large" Color="Color.Secondary" />
                                <MudText Color="Color.Secondary" Class="mt-2">Nenhum comentário ainda</MudText>
                            </div>
                        }
                    </MudCardContent>
                    <MudCardActions Class="d-block pa-4">
                        <MudTextField @bind-Value="newComment"
                                      Label="Adicionar Comentário"
                                      Variant="Variant.Outlined"
                                      Lines="3"
                                      MaxLength="1000"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@Icons.Material.Filled.Send"
                                      OnAdornmentClick="AddComment" />
                        <div class="d-flex justify-end mt-2">
                             <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Disabled="@(string.IsNullOrWhiteSpace(newComment) || isAddingComment)"
                                       OnClick="AddComment"
                                       StartIcon="@Icons.Material.Filled.Send">
                                @if (isAddingComment)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2">Enviando...</MudText>
                                }
                                else
                                {
                                    <MudText>Enviar</MudText>
                                }
                            </MudButton>
                        </div>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <!-- Coluna Lateral -->
            <MudItem xs="12" md="4">
                <!-- Status e Informações -->
                <MudCard Class="mb-4" Elevation="3">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Detalhes</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true" DisablePadding="true">
                            <MudListItem Icon="@Icons.Material.Filled.Info">
                                <div class="d-flex justify-space-between align-center width-100">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Status</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="GetStatusColor(order.StatusName)" Variant="Variant.Filled" Class="ma-0">
                                        @order.StatusName
                                    </MudChip>
                                </div>
                            </MudListItem>
                            <MudDivider />
                            
                             <MudListItem Icon="@Icons.Material.Filled.Category">
                                <div class="d-flex justify-space-between align-center width-100">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Tipo</MudText>
                                    <MudText Typo="Typo.body2" Align="Align.End">@order.TypeName</MudText>
                                </div>
                            </MudListItem>
                            <MudDivider />

                            @if (!string.IsNullOrEmpty(order.DepartmentName))
                            {
                                <MudListItem Icon="@Icons.Material.Filled.Business">
                                    <div class="d-flex justify-space-between align-center width-100">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">Departamento</MudText>
                                        <MudText Typo="Typo.body2" Align="Align.End">@order.DepartmentName</MudText>
                                    </div>
                                </MudListItem>
                                <MudDivider />
                            }

                             @if (!string.IsNullOrEmpty(order.CategoryName))
                            {
                                <MudListItem Icon="@Icons.Material.Filled.Class">
                                    <div class="d-flex justify-space-between align-center width-100">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">Categoria</MudText>
                                        <MudText Typo="Typo.body2" Align="Align.End">@order.CategoryName</MudText>
                                    </div>
                                </MudListItem>
                                <MudDivider />
                            }
                            
                            @if (!string.IsNullOrEmpty(order.SubCategoryName))
                            {
                                <MudListItem Icon="@Icons.Material.Filled.SubdirectoryArrowRight">
                                    <div class="d-flex justify-space-between align-center width-100">
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">Subcategoria</MudText>
                                        <MudText Typo="Typo.body2" Align="Align.End">@order.SubCategoryName</MudText>
                                    </div>
                                </MudListItem>
                                <MudDivider />
                            }

                             <MudListItem Icon="@Icons.Material.Filled.Event">
                                <div class="d-flex justify-space-between align-center width-100">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Prazo</MudText>
                                    @if (order.DueDate.HasValue)
                                    {
                                        @if (order.IsOverdue)
                                        {
                                            <MudText Color="Color.Error" Typo="Typo.body2" Align="Align.End">@order.DueDate.Value.ToString("dd/MM/yyyy") (Vencido)</MudText>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Align="Align.End">@order.DueDate.Value.ToString("dd/MM/yyyy")</MudText>
                                        }
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Align="Align.End">-</MudText>
                                    }
                                </div>
                            </MudListItem>
                            <MudDivider />

                            <MudListItem Icon="@Icons.Material.Filled.Person">
                                <div class="d-flex flex-column width-100">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Solicitante</MudText>
                                    <MudText Typo="Typo.body2" Class="text-truncate">@order.RequestingUserEmail</MudText>
                                </div>
                            </MudListItem>
                            <MudDivider />

                             <MudListItem Icon="@Icons.Material.Filled.SupportAgent">
                                <div class="d-flex flex-column width-100">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Responsável</MudText>
                                    <MudText Typo="Typo.body2" Class="text-truncate">
                                        @(string.IsNullOrEmpty(order.ResponsibleUserEmail) ? "Não atribuído" : order.ResponsibleUserEmail)
                                    </MudText>
                                </div>
                            </MudListItem>
                        </MudList>
                    </MudCardContent>
                </MudCard>

                <!-- Ações Rápidas -->
                <MudCard Elevation="3">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Ações</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudSelect T="Guid" @bind-Value="selectedStatusId"
                                   Label="Alterar Status"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Class="mb-3">
                            @foreach (var status in statuses)
                            {
                                <MudSelectItem Value="@status.Id">@status.Name</MudSelectItem>
                            }
                        </MudSelect>

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   Disabled="@(selectedStatusId == order.StatusId || isUpdatingStatus)"
                                   OnClick="UpdateStatus"
                                   Class="mb-3">
                            @if (isUpdatingStatus)
                            {
                                <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                                <span>Atualizando...</span>
                            }
                            else
                            {
                                <span>Atualizar Status</span>
                            }
                        </MudButton>

                        <!-- Assumir chamado -->
                        @if (string.IsNullOrEmpty(order.ResponsibleUserEmail))
                        {
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Info"
                                       FullWidth="true"
                                       Disabled="isAssigning"
                                       OnClick="AssignToMe"
                                       StartIcon="@Icons.Material.Filled.AssignmentInd">
                                @if (isAssigning)
                                {
                                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                                    <span>Assumindo...</span>
                                }
                                else
                                {
                                    <span>Assumir Chamado</span>
                                }
                            </MudButton>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private OrderViewModel? order;
    private bool isLoading = true;
    private string newComment = string.Empty;
    private bool isAddingComment;
    private bool isUpdatingStatus;
    private bool isAssigning;

    // Lookups
    private List<StatusTypeResponse> statuses = new();
    private Guid selectedStatusId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Carrega o chamado e os status em paralelo
            var orderTask = OrderService.GetByIdAsync(Id);
            var statusTask = LookupService.GetStatusTypesAsync();
            var commentsTask = CommentService.GetByOrderIdAsync(Id);

            await Task.WhenAll(orderTask, statusTask, commentsTask);

            order = await orderTask;
            statuses = await statusTask;

            if (order != null)
            {
                order = order with { Comments = await commentsTask };
                selectedStatusId = order.StatusId;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar chamado: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task AddComment()
    {
        if (string.IsNullOrWhiteSpace(newComment))
            return;

        isAddingComment = true;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var userEmail = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value
                ?? authState.User.Identity?.Name ?? "Usuário";

            if (string.IsNullOrEmpty(userId))
            {
                Snackbar.Add("Não foi possível identificar o usuário", Severity.Error);
                return;
            }

            var request = new AddCommentRequest(Id, newComment, Guid.Parse(userId), userEmail);
            await OrderService.AddCommentAsync(request);

            Snackbar.Add("Comentário adicionado com sucesso!", Severity.Success);
            newComment = string.Empty;

            // Recarrega o chamado para mostrar o novo comentário
            await ReloadOrder();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao adicionar comentário: {ex.Message}", Severity.Error);
        }
        finally
        {
            isAddingComment = false;
        }
    }

    private async Task UpdateStatus()
    {
        if (selectedStatusId == order?.StatusId)
            return;

        isUpdatingStatus = true;

        try
        {
            await OrderService.ChangeStatusAsync(Id, selectedStatusId);

            Snackbar.Add("Status atualizado com sucesso!", Severity.Success);

            // Recarrega o chamado
            await ReloadOrder();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao atualizar status: {ex.Message}", Severity.Error);
        }
        finally
        {
            isUpdatingStatus = false;
        }
    }

    private async Task AssignToMe()
    {
        isAssigning = true;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                Snackbar.Add("Não foi possível identificar o usuário", Severity.Error);
                return;
            }

            await OrderService.AssignAsync(Id, Guid.Parse(userId));

            Snackbar.Add("Chamado assumido com sucesso!", Severity.Success);

            // Recarrega o chamado
            await ReloadOrder();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao assumir chamado: {ex.Message}", Severity.Error);
        }
        finally
        {
            isAssigning = false;
        }
    }

    private async Task ReloadOrder()
    {
        var orderTask = OrderService.GetByIdAsync(Id);
        var commentsTask = CommentService.GetByOrderIdAsync(Id);

        await Task.WhenAll(orderTask, commentsTask);

        var loadedOrder = await orderTask;
        if (loadedOrder != null)
        {
            order = loadedOrder with { Comments = await commentsTask };
            selectedStatusId = order.StatusId;
        }
    }

    private Color GetStatusColor(string status) => status.ToLower() switch
    {
        var s when s.Contains("aberto") || s.Contains("open") => Color.Info,
        var s when s.Contains("andamento") || s.Contains("progress") => Color.Warning,
        var s when s.Contains("fechado") || s.Contains("closed") || s.Contains("resolvido") => Color.Success,
        _ => Color.Default
    };
}
