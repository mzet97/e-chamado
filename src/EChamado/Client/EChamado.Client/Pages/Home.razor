@page "/"
@using EChamado.Client.Services
@using EChamado.Client.Models
@using EChamado.Client.Authentication
@inject OrderService OrderService
@inject LookupService LookupService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]

<PageTitle>Dashboard - EChamado</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Dashboard</MudText>

    <!-- Debug Panel (Hidden by default, can be toggled) -->
    <MudCard Class="mb-4" Color="Color.Warning" Style="@((showDebug ? "" : "display: none;"))">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">üîß Debug - Estado de Autentica√ß√£o</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                               Color="Color.Default" 
                               OnClick="() => showDebug = false" />
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudStack>
                <MudText><strong>Estado de Autentica√ß√£o:</strong> @authState</MudText>
                <MudText><strong>Token Encontrado:</strong> @(!string.IsNullOrEmpty(testToken) ? "‚úÖ Sim" : "‚ùå N√£o")</MudText>
                @if (!string.IsNullOrEmpty(testToken))
                {
                    <MudText><strong>Token Preview:</strong> @testToken.Substring(0, Math.Min(50, testToken.Length))...</MudText>
                }
                <MudText><strong>Claims Count:</strong> @claimsCount</MudText>
                <MudText><strong>User Identity:</strong> @userIdentity</MudText>
                
                <MudStack Row="true">
                    <MudButton Size="Size.Small" 
                               Variant="Variant.Outlined" 
                               Color="Color.Primary" 
                               OnClick="TestAuthState">
                        üîÑ Testar Estado
                    </MudButton>
                    <MudButton Size="Size.Small" 
                               Variant="Variant.Outlined" 
                               Color="Color.Secondary" 
                               OnClick="ForceLogout">
                        üö™ Logout
                    </MudButton>
                    <MudButton Size="Size.Small" 
                               Variant="Variant.Outlined" 
                               Color="Color.Success" 
                               OnClick="TestLogin">
                        üîê Login Teste
                    </MudButton>
                    <MudButton Size="Size.Small" 
                               Variant="Variant.Outlined" 
                               Color="Color.Info" 
                               OnClick="DownloadLogs">
                        üì• Baixar Logs
                    </MudButton>
                    <MudButton Size="Size.Small" 
                               Variant="Variant.Outlined" 
                               Color="Color.Warning" 
                               OnClick="ClearLogs">
                        üóëÔ∏è Limpar Logs
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudCardContent>
    </MudCard>

    <!-- Show debug button when not visible -->
    @if (!showDebug)
    {
        <MudButton Size="Size.Small" 
                   Variant="Variant.Text" 
                   Color="Color.Warning" 
                   StartIcon="@Icons.Material.Filled.BugReport"
                   OnClick="() => showDebug = true"
                   Class="mb-2">
            Mostrar Debug
        </MudButton>
    }

    @if (isLoading)
    {
        <MudGrid>
            @for (int i = 0; i < 4; i++)
            {
                <MudItem xs="12" sm="6" md="3">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="120px" />
                </MudItem>
            }
        </MudGrid>
    }
    else if (errorMessage != null)
    {
        <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
    }
    else
    {
        <!-- Cards de Estat√≠sticas -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="2">
                    <MudCardContent>
                        <div class="d-flex justify-space-between">
                            <div>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Total de Chamados</MudText>
                                <MudText Typo="Typo.h4">@stats.TotalTickets</MudText>
                            </div>
                            <MudIcon Icon="@Icons.Material.Filled.ConfirmationNumber" Size="Size.Large" Color="Color.Primary" />
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="2">
                    <MudCardContent>
                        <div class="d-flex justify-space-between">
                            <div>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Meus Chamados</MudText>
                                <MudText Typo="Typo.h4">@stats.MyTickets</MudText>
                            </div>
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" Color="Color.Info" />
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="2">
                    <MudCardContent>
                        <div class="d-flex justify-space-between">
                            <div>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Atribu√≠dos a Mim</MudText>
                                <MudText Typo="Typo.h4">@stats.AssignedToMe</MudText>
                            </div>
                            <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Color="Color.Success" />
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="2">
                    <MudCardContent>
                        <div class="d-flex justify-space-between">
                            <div>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Vencidos</MudText>
                                <MudText Typo="Typo.h4" Color="Color.Error">@stats.OverdueTickets</MudText>
                            </div>
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Large" Color="Color.Error" />
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Gr√°ficos -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Chamados por Status</MudText>
                    @if (chartDataByStatus.Any())
                    {
                        <MudChart ChartType="ChartType.Donut"
                                  InputData="@chartDataByStatus"
                                  InputLabels="@chartLabelsByStatus"
                                  Width="100%"
                                  Height="300px" />
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Nenhum dado dispon√≠vel</MudText>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Chamados por Departamento</MudText>
                    @if (chartDataByDepartment.Any())
                    {
                        <MudChart ChartType="ChartType.Bar"
                                  ChartSeries="@chartSeriesByDepartment"
                                  XAxisLabels="@chartLabelsByDepartment"
                                  Width="100%"
                                  Height="300px" />
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Nenhum dado dispon√≠vel</MudText>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- √öltimos Chamados -->
        <MudPaper Class="pa-4" Elevation="2">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6">√öltimos Chamados</MudText>
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           EndIcon="@Icons.Material.Filled.ArrowForward"
                           Href="/orders">
                    Ver Todos
                </MudButton>
            </div>

            @if (recentTickets.Any())
            {
                <MudDataGrid T="OrderListViewModel"
                             Items="@recentTickets"
                             QuickFilter="@RecentQuickFilter"
                             Filterable="true"
                             Sortable="true"
                             Dense="true"
                             Hover="true"
                             Striped="true"
                             Bordered="true"
                             PageSize="10"
                             PageSizeOptions="@(new int[] { 5, 10, 20 })">
                    <ToolBarContent>
                        <MudTextField @bind-Value="recentSearch"
                                      Placeholder="Buscar chamados..."
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      IconSize="Size.Medium"
                                      Class="mt-0" />
                    </ToolBarContent>
                    <Columns>
                        <PropertyColumn Property="x => x.Title" Title="T√≠tulo" Sortable="true" Filterable="true" />
                        <TemplateColumn Title="Status" Sortable="true" Filterable="true">
                            <CellTemplate>
                                <MudChip T="string" Size="Size.Small" Color="GetStatusColor(context.Item.StatusName)">
                                    @context.Item.StatusName
                                </MudChip>
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="x => x.DepartmentName" Title="Departamento" Sortable="true" Filterable="true" />
                        <TemplateColumn Title="Data" Property="x => x.OpeningDate" Sortable="true">
                            <CellTemplate>
                                <MudText>@context.Item.OpeningDate.ToString("dd/MM/yyyy")</MudText>
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="A√ß√µes" Align="MudBlazor.Align.Right" Sortable="false" Filterable="false">
                            <CellTemplate>
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                               Size="Size.Small"
                                               Color="Color.Primary"
                                               Href="@($"/orders/{context.Item.Id}")" />
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                    <PagerContent>
                        <MudDataGridPager T="OrderListViewModel" PageSizeOptions="@(new int[] { 5, 10, 20 })" />
                    </PagerContent>
                </MudDataGrid>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">Nenhum chamado encontrado</MudText>
            }
        </MudPaper>

        <!-- Atalhos R√°pidos -->
        <MudGrid Class="mt-4">
            <MudItem xs="12" sm="6" md="4">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           FullWidth="true"
                           Size="Size.Large"
                           Href="/orders/create">
                    Criar Novo Chamado
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Info"
                           StartIcon="@Icons.Material.Filled.List"
                           FullWidth="true"
                           Size="Size.Large"
                           Href="/orders">
                    Ver Todos os Chamados
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Success"
                           StartIcon="@Icons.Material.Filled.Assignment"
                           FullWidth="true"
                           Size="Size.Large"
                           Href="/orders?assigned=true">
                    Meus Atribu√≠dos
                </MudButton>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private bool isLoading = true;
    private string? errorMessage;
    private bool showDebug = false;

    // Debug properties
    private string authState = "Checking...";
    private string? testToken = null;
    private int claimsCount = 0;
    private string userIdentity = "Unknown";

    private DashboardStats stats = new();
    private List<OrderListViewModel> recentTickets = new();
    private string recentSearch = string.Empty;

    // Dados para gr√°ficos
    private double[] chartDataByStatus = Array.Empty<double>();
    private string[] chartLabelsByStatus = Array.Empty<string>();
    private double[] chartDataByDepartment = Array.Empty<double>();
    private string[] chartLabelsByDepartment = Array.Empty<string>();
    private List<ChartSeries> chartSeriesByDepartment = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;

            // Inicializa debug state
            await TestAuthState();

            // Carrega estat√≠sticas em paralelo
            var allTicketsTask = OrderService.SearchAsync(new SearchOrdersParameters { PageSize = 100 });
            // Removido chamadas para endpoints inexistentes: my-tickets e assigned-to-me
            // TODO: Implementar endpoints no Server ou usar filtros apropriados
            var overdueTask = OrderService.SearchAsync(new SearchOrdersParameters { IsOverdue = true, PageSize = 100 });
            var statusesTask = LookupService.GetStatusTypesAsync();

            await Task.WhenAll(allTicketsTask, overdueTask, statusesTask);

            var allTickets = await allTicketsTask;
            var overdue = await overdueTask;
            var statuses = await statusesTask;

            // Calcula estat√≠sticas
            stats = new DashboardStats
            {
                TotalTickets = allTickets.TotalCount,
                MyTickets = 0, // TODO: Implementar endpoint /v1/orders/my-tickets
                AssignedToMe = 0, // TODO: Implementar endpoint /v1/orders/assigned-to-me
                OverdueTickets = overdue.TotalCount
            };

            // √öltimos chamados
            recentTickets = allTickets.Items.Take(25).ToList();

            // Dados para gr√°fico de status
            var groupedByStatus = allTickets.Items
                .GroupBy(t => t.StatusName)
                .Select(g => new { Status = g.Key, Count = g.Count() })
                .ToList();

            chartLabelsByStatus = groupedByStatus.Select(g => g.Status).ToArray();
            chartDataByStatus = groupedByStatus.Select(g => (double)g.Count).ToArray();

            // Dados para gr√°fico de departamento
            var groupedByDepartment = allTickets.Items
                .Where(t => !string.IsNullOrEmpty(t.DepartmentName))
                .GroupBy(t => t.DepartmentName!)
                .Select(g => new { Department = g.Key, Count = g.Count() })
                .ToList();

            chartLabelsByDepartment = groupedByDepartment.Select(g => g.Department).ToArray();
            chartDataByDepartment = groupedByDepartment.Select(g => (double)g.Count).ToArray();

            chartSeriesByDepartment = new List<ChartSeries>
            {
                new ChartSeries { Name = "Chamados", Data = chartDataByDepartment }
            };
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro ao carregar dashboard: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private Func<OrderListViewModel, bool> RecentQuickFilter => order =>
    {
        if (string.IsNullOrWhiteSpace(recentSearch))
            return true;

        var term = recentSearch.ToLowerInvariant();
        return (order.Title?.ToLowerInvariant().Contains(term) ?? false)
            || (order.StatusName?.ToLowerInvariant().Contains(term) ?? false)
            || (order.DepartmentName?.ToLowerInvariant().Contains(term) ?? false)
            || (order.RequestingUserEmail?.ToLowerInvariant().Contains(term) ?? false);
    };

    private Color GetStatusColor(string status) => status.ToLower() switch
    {
        var s when s.Contains("aberto") || s.Contains("open") => Color.Info,
        var s when s.Contains("andamento") || s.Contains("progress") => Color.Warning,
        var s when s.Contains("fechado") || s.Contains("closed") || s.Contains("resolvido") => Color.Success,
        _ => Color.Default
    };

    #region Debug Methods
    private async Task TestAuthState()
    {
        try
        {
            // Testa token no localStorage
            testToken = await JS.InvokeAsync<string?>("localStorage.getItem", "authToken");
            
            // Testa estado de autentica√ß√£o do provider
            var authStateResult = await AuthStateProvider.GetAuthenticationStateAsync();
            authState = authStateResult.User?.Identity?.IsAuthenticated == true ? "‚úÖ Authenticated" : "‚ùå Not Authenticated";
            
            // Conta claims
            claimsCount = authStateResult.User?.Claims?.Count() ?? 0;
            
            // Pega identity do usu√°rio
            userIdentity = authStateResult.User?.Identity?.Name ?? "None";
            
            Console.WriteLine($"üîç Debug - Auth State: {authState}");
            Console.WriteLine($"üîç Debug - Token: {testToken?.Substring(0, Math.Min(20, testToken.Length))}...");
            Console.WriteLine($"üîç Debug - Claims: {claimsCount}");
            Console.WriteLine($"üîç Debug - Identity: {userIdentity}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Debug error: {ex.Message}");
            authState = $"‚ùå Error: {ex.Message}";
        }
    }

    private async Task ForceLogout()
    {
        try
        {
            await JS.InvokeVoidAsync("localStorage.removeItem", "authToken");
            await JS.InvokeVoidAsync("localStorage.removeItem", "refreshToken");
            await JS.InvokeVoidAsync("localStorage.removeItem", "pkce_code_verifier");
            
            testToken = null;
            authState = "‚ùå Not Authenticated (Logged Out)";
            claimsCount = 0;
            userIdentity = "None";
            
            Console.WriteLine("üö™ Forced logout completed");
            
            // Redireciona para login
            NavigationManager.NavigateTo("/authentication/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Logout error: {ex.Message}");
        }
    }

    private async Task TestLogin()
    {
        try
        {
            Console.WriteLine("üîê Starting test login...");

            // Cast para CookieAuthenticationStateProvider se necess√°rio
            if (AuthStateProvider is CookieAuthenticationStateProvider cookieProvider)
            {
                var success = await cookieProvider.LoginAsync("admin@admin.com", "Admin@123");

                if (success)
                {
                    await TestAuthState(); // Atualiza debug info
                    Console.WriteLine("‚úÖ Test login successful");
                }
                else
                {
                    Console.WriteLine("‚ùå Test login failed");
                    authState = "‚ùå Login Failed";
                }
            }
            else
            {
                Console.WriteLine("‚ùå AuthStateProvider is not CookieAuthenticationStateProvider");
                authState = "‚ùå Invalid Provider Type";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Test login error: {ex.Message}");
            authState = $"‚ùå Login Error: {ex.Message}";
        }
    }
    #endregion

    #region Log Methods
    private async Task DownloadLogs()
    {
        try
        {
            await JS.InvokeVoidAsync("window.EChamadoLogger.downloadLogs", "echamado-auth-debug.log");
            await JS.InvokeVoidAsync("window.EChamadoLogger.info", "HOME", "Logs downloaded successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error downloading logs: {ex.Message}");
        }
    }

    private async Task ClearLogs()
    {
        try
        {
            await JS.InvokeVoidAsync("window.EChamadoLogger.clearLogs");
            await JS.InvokeVoidAsync("window.EChamadoLogger.info", "HOME", "Logs cleared successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error clearing logs: {ex.Message}");
        }
    }
    #endregion

    private class DashboardStats
    {
        public int TotalTickets { get; set; }
        public int MyTickets { get; set; }
        public int AssignedToMe { get; set; }
        public int OverdueTickets { get; set; }
    }
}
