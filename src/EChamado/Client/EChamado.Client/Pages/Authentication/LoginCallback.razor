@page "/authentication/login-callback"
@inject NavigationManager Navigation
@inject ILogger<LoginCallback> Logger
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Components.Authorization
@using EChamado.Client.Authentication
@using EChamado.Client.Services
@inject EChamado.Client.Authentication.AuthService AuthService
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject PersistentLogger PersistentLog

<PageTitle>Login Callback</PageTitle>

<div style="text-align: center; padding: 50px;">
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    <p>Processando login...</p>
</div>

@code {
    private static bool _isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        // Previne execu√ß√£o duplicada causada por re-renders
        if (_isProcessing)
        {
            await PersistentLog.WarnAsync("CALLBACK", "‚ö†Ô∏è Callback already processing - skipping duplicate execution");
            return;
        }

        _isProcessing = true;

        try
        {
            // ========== ETAPA 1: In√≠cio do Callback ==========
            await PersistentLog.AuthAsync("üî• LOGIN CALLBACK STARTED", $"URL: {Navigation.Uri}");
            Logger.LogInformation("Login callback received. URL: {Uri}", Navigation.Uri);

            // Extrai par√¢metros da URL
            var uri = new Uri(Navigation.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var code = query["code"];
            var state = query["state"];

            // ========== ETAPA 2: Par√¢metros Extra√≠dos ==========
            await PersistentLog.AuthAsync("üìã Parameters extracted",
                $"Code: {code?.Length ?? 0} chars, State: {state?.Length ?? 0} chars, Query: {uri.Query}");
            Logger.LogInformation("Code: {CodeLen} chars, State: {StateLen} chars",
                code?.Length ?? 0, state?.Length ?? 0);

            if (!string.IsNullOrEmpty(code) && !string.IsNullOrEmpty(state))
            {
                // ========== ETAPA 3: Par√¢metros V√°lidos ==========
                await PersistentLog.AuthAsync("‚úÖ Code and State VALID - Starting exchange");
                Logger.LogInformation("Processing authorization code exchange");

                // Obt√©m o code verifier do localStorage
                var codeVerifier = await AuthService.GetCodeVerifierAsync();

                // ========== ETAPA 4: Code Verifier Obtido ==========
                await PersistentLog.AuthAsync($"üîë Code verifier retrieved: {codeVerifier?.Length ?? 0} chars");
                Logger.LogInformation("Code verifier length: {Length}", codeVerifier?.Length ?? 0);

                // ========== ETAPA 5: Iniciando Troca de Token ==========
                await PersistentLog.AuthAsync("üîÑ Starting ExchangeCodeForTokenAsync...");

                // Troca o c√≥digo por token
                var success = await AuthService.ExchangeCodeForTokenAsync(code, state, codeVerifier ?? "");

                // ========== ETAPA 6: Resultado do Exchange ==========
                await PersistentLog.AuthAsync($"üì° Exchange completed: {(success ? "SUCCESS ‚úÖ" : "FAILED ‚ùå")}");

                if (success)
                {
                    Logger.LogInformation("Token exchange successful");

                    // ========== ETAPA 7: Verificando Token em localStorage ==========
                    var storedToken = await JS.InvokeAsync<string?>("localStorage.getItem", "authToken");
                    var tokenPreview = storedToken != null
                        ? storedToken.Substring(0, Math.Min(30, storedToken.Length)) + "..."
                        : "NULL";

                    await PersistentLog.AuthAsync("üíæ Token verification",
                        $"Token in localStorage: {(storedToken != null ? $"{storedToken.Length} chars" : "NOT FOUND")} - Preview: {tokenPreview}");
                    Logger.LogInformation("Token stored: {Preview}", tokenPreview);

                    // ========== ETAPA 8: Limpando Code Verifier ==========
                    await JS.InvokeVoidAsync("localStorage.removeItem", "pkce_code_verifier");
                    await PersistentLog.DebugAsync("CLEANUP", "Code verifier removed from localStorage");

                    // ========== ETAPA 9: Notificando AuthenticationStateProvider ==========
                    var authStateProvider = AuthStateProvider as CookieAuthenticationStateProvider;
                    if (authStateProvider != null)
                    {
                        await PersistentLog.AuthAsync("üîî Calling NotifyUserAuthenticated()...");
                        authStateProvider.NotifyUserAuthenticated();
                        await PersistentLog.AuthAsync("‚úÖ AUTHENTICATION STATE NOTIFIED - User should be logged in now");
                    }
                    else
                    {
                        await PersistentLog.AuthErrorAsync("‚ùå AuthStateProvider is NULL or wrong type");
                    }

                    Logger.LogInformation("‚úÖ Authentication state notified");
                }
                else
                {
                    // ========== FALHA NO EXCHANGE ==========
                    await PersistentLog.AuthErrorAsync("‚ùå Token exchange returned FALSE");
                    Logger.LogWarning("Token exchange failed - no success flag received");
                }
            }
            else
            {
                // ========== PAR√ÇMETROS INV√ÅLIDOS ==========
                await PersistentLog.AuthErrorAsync($"‚ùå MISSING PARAMETERS - Code: {string.IsNullOrEmpty(code)}, State: {string.IsNullOrEmpty(state)}");
                Logger.LogWarning("Missing code or state in callback URL");
            }

            // ========== ETAPA 10: Redirecionando ==========
            await PersistentLog.AuthAsync("üîÄ Redirecting to home page NOW (no delay to prevent re-render)");
            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            // ========== ERRO CR√çTICO ==========
            await PersistentLog.AuthErrorAsync($"‚ùå CRITICAL EXCEPTION: {ex.Message}", ex.StackTrace);
            Logger.LogError(ex, "Error processing login callback");
            Navigation.NavigateTo("/", forceLoad: true);
        }
        finally
        {
            // Reset flag ap√≥s 2 segundos (tempo suficiente para o redirect acontecer)
            _ = Task.Run(async () =>
            {
                await Task.Delay(2000);
                _isProcessing = false;
                await PersistentLog.DebugAsync("CALLBACK", "Processing flag reset - ready for new login");
            });
        }
    }
}
