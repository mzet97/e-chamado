@using EChamado.Client.Services
@using MudBlazor
@inject IJSRuntime JSRuntime

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6">Informações de Query</MudText>

            @if (!string.IsNullOrEmpty(Query))
            {
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Query Gridify:</MudText>
                    <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                        <code style="font-size: 0.9em; word-break: break-all;">@Query</code>
                    </MudPaper>
                </div>
            }

            @if (!string.IsNullOrEmpty(ODataQuery))
            {
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Query OData:</MudText>
                    <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                        <code style="font-size: 0.9em; word-break: break-all;">@ODataQuery</code>
                    </MudPaper>
                </div>
            }

            @if (!string.IsNullOrEmpty(Provider))
            {
                <MudAlert Severity="Severity.Info" Dense="true">
                    <MudText Typo="Typo.body2">
                        <strong>Provider:</strong> @Provider
                        @if (!string.IsNullOrEmpty(Model))
                        {
                            <text> (@Model)</text>
                        }
                    </MudText>
                    @if (ResponseTimeMs > 0)
                    {
                        <MudText Typo="Typo.caption">
                            Tempo: @ResponseTimeMs ms
                            @if (FromCache)
                            {
                                <text> | ⚡ Cache</text>
                            }
                        </MudText>
                    }
                    @if (TokensUsed > 0)
                    {
                        <MudText Typo="Typo.caption">
                            Tokens: @TokensUsed
                        </MudText>
                    }
                </MudAlert>
            }

            @if (TotalCount > 0)
            {
                <MudAlert Severity="Severity.Success" Dense="true">
                    <MudText Typo="Typo.body2">
                        <strong>Total de resultados:</strong> @TotalCount
                    </MudText>
                    @if (TotalPages > 1)
                    {
                        <MudText Typo="Typo.caption">
                            Página @Page de @TotalPages
                        </MudText>
                    }
                </MudAlert>
            }

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <MudAlert Severity="Severity.Error">
                    <MudText Typo="Typo.body2">@ErrorMessage</MudText>
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CopyToClipboard" StartIcon="@Icons.Material.Outlined.ContentCopy" Color="Color.Primary">
            Copiar Query
        </MudButton>
        <MudButton OnClick="Close" Color="Color.Default">
            Fechar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private object? MudDialog { get; set; }

    [Parameter]
    public string Query { get; set; } = string.Empty;

    [Parameter]
    public string? ODataQuery { get; set; }

    [Parameter]
    public string? Provider { get; set; }

    [Parameter]
    public string? Model { get; set; }

    [Parameter]
    public int ResponseTimeMs { get; set; }

    [Parameter]
    public bool FromCache { get; set; }

    [Parameter]
    public int TokensUsed { get; set; }

    [Parameter]
    public int TotalCount { get; set; }

    [Parameter]
    public int TotalPages { get; set; }

    [Parameter]
    public int Page { get; set; }

    [Parameter]
    public string? ErrorMessage { get; set; }

    private void Close()
    {
        (MudDialog as dynamic)?.Close();
    }

    private async Task CopyToClipboard()
    {
        var text = !string.IsNullOrEmpty(Query) ? Query : ODataQuery;
        if (!string.IsNullOrEmpty(text))
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        }
    }
}
