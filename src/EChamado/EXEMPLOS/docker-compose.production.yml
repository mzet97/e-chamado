# Docker Compose para Produção - EChamado
# Este arquivo contém configurações otimizadas para ambiente de produção

version: '3.8'

services:
  # Proxy Reverso e Load Balancer
  nginx:
    image: nginx:1.25-alpine
    container_name: echamado-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - echamado-server-1
      - echamado-server-2
      - echamado-auth
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # API Server - Instância 1
  echamado-server-1:
    image: echamado/server:${VERSION:-latest}
    container_name: echamado-server-1
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=${DATABASE_CONNECTION_STRING}
      - ConnectionStrings__Redis=${REDIS_CONNECTION_STRING}
      - ConnectionStrings__RabbitMQ=${RABBITMQ_CONNECTION_STRING}
      - ConnectionStrings__Elasticsearch=${ELASTICSEARCH_CONNECTION_STRING}
      - OpenIddict__Issuer=${OPENIDDICT_ISSUER}
      - OpenIddict__SigningCertificate=${SIGNING_CERTIFICATE_PATH}
      - OpenIddict__EncryptionCertificate=${ENCRYPTION_CERTIFICATE_PATH}
      - Serilog__WriteTo__1__Args__serverUrl=${ELASTICSEARCH_URL}
      - Serilog__WriteTo__1__Args__indexFormat=echamado-logs-{0:yyyy.MM.dd}
    volumes:
      - ./certs:/app/certs:ro
      - ./logs:/app/logs
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - elasticsearch
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # API Server - Instância 2
  echamado-server-2:
    image: echamado/server:${VERSION:-latest}
    container_name: echamado-server-2
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=${DATABASE_CONNECTION_STRING}
      - ConnectionStrings__Redis=${REDIS_CONNECTION_STRING}
      - ConnectionStrings__RabbitMQ=${RABBITMQ_CONNECTION_STRING}
      - ConnectionStrings__Elasticsearch=${ELASTICSEARCH_CONNECTION_STRING}
      - OpenIddict__Issuer=${OPENIDDICT_ISSUER}
      - OpenIddict__SigningCertificate=${SIGNING_CERTIFICATE_PATH}
      - OpenIddict__EncryptionCertificate=${ENCRYPTION_CERTIFICATE_PATH}
      - Serilog__WriteTo__1__Args__serverUrl=${ELASTICSEARCH_URL}
      - Serilog__WriteTo__1__Args__indexFormat=echamado-logs-{0:yyyy.MM.dd}
    volumes:
      - ./certs:/app/certs:ro
      - ./logs:/app/logs
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - elasticsearch
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Authentication UI
  echamado-auth:
    image: echamado/auth:${VERSION:-latest}
    container_name: echamado-auth
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=${DATABASE_CONNECTION_STRING}
      - AuthServer__Authority=${OPENIDDICT_ISSUER}
    volumes:
      - ./logs:/app/logs
    depends_on:
      - postgres
      - echamado-server-1
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: echamado-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-echamado}
      - POSTGRES_USER=${POSTGRES_USER:-echamado_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
      - ./postgres/config/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    ports:
      - "5432:5432"
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-echamado_user} -d ${POSTGRES_DB:-echamado}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    command: [
      "postgres",
      "-c", "config_file=/etc/postgresql/postgresql.conf",
      "-c", "log_statement=all",
      "-c", "log_destination=stderr",
      "-c", "logging_collector=on",
      "-c", "log_directory=/var/log/postgresql",
      "-c", "log_filename=postgresql-%Y-%m-%d.log"
    ]

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: echamado-redis
    restart: unless-stopped
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/etc/redis/redis.conf:ro
    ports:
      - "6379:6379"
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    command: [
      "redis-server",
      "/etc/redis/redis.conf",
      "--requirepass", "${REDIS_PASSWORD}",
      "--appendonly", "yes",
      "--maxmemory", "1gb",
      "--maxmemory-policy", "allkeys-lru"
    ]

  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: echamado-rabbitmq
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-admin}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_DEFAULT_VHOST=echamado
      - RABBITMQ_ERLANG_COOKIE=${RABBITMQ_ERLANG_COOKIE}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: echamado-elasticsearch
    restart: unless-stopped
    environment:
      - node.name=echamado-es-node
      - cluster.name=echamado-cluster
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
      - ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
    ports:
      - "9200:9200"
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536

  # Kibana
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: echamado-kibana
    restart: unless-stopped
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - SERVER_NAME=kibana.echamado.local
    volumes:
      - ./kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # Prometheus (Metrics)
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: echamado-prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'

  # Grafana (Dashboards)
  grafana:
    image: grafana/grafana:10.2.0
    container_name: echamado-grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Background Workers
  echamado-worker-notifications:
    image: echamado/worker:${VERSION:-latest}
    container_name: echamado-worker-notifications
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - WORKER_TYPE=notifications
      - ConnectionStrings__DefaultConnection=${DATABASE_CONNECTION_STRING}
      - ConnectionStrings__Redis=${REDIS_CONNECTION_STRING}
      - ConnectionStrings__RabbitMQ=${RABBITMQ_CONNECTION_STRING}
      - Email__SmtpHost=${SMTP_HOST}
      - Email__SmtpPort=${SMTP_PORT}
      - Email__Username=${SMTP_USERNAME}
      - Email__Password=${SMTP_PASSWORD}
    volumes:
      - ./logs:/app/logs
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      replicas: 2

  echamado-worker-reports:
    image: echamado/worker:${VERSION:-latest}
    container_name: echamado-worker-reports
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - WORKER_TYPE=reports
      - ConnectionStrings__DefaultConnection=${DATABASE_CONNECTION_STRING}
      - ConnectionStrings__Redis=${REDIS_CONNECTION_STRING}
      - ConnectionStrings__RabbitMQ=${RABBITMQ_CONNECTION_STRING}
    volumes:
      - ./logs:/app/logs
      - ./reports:/app/reports
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - echamado-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/echamado/postgres
  
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/echamado/redis
  
  rabbitmq_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/echamado/rabbitmq
  
  elasticsearch_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/echamado/elasticsearch
  
  prometheus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/echamado/prometheus
  
  grafana_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/echamado/grafana

networks:
  echamado-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

# Configurações de deploy para Docker Swarm (opcional)
# Para usar: docker stack deploy -c docker-compose.production.yml echamado
# 
# deploy:
#   mode: replicated
#   replicas: 2
#   placement:
#     constraints:
#       - node.role == worker
#   resources:
#     limits:
#       cpus: '2.0'
#       memory: 4G
#     reservations:
#       cpus: '1.0'
#       memory: 2G
#   restart_policy:
#     condition: on-failure
#     delay: 5s
#     max_attempts: 3
#     window: 120s
#   update_config:
#     parallelism: 1
#     delay: 10s
#     failure_action: rollback
#     monitor: 60s
#     max_failure_ratio: 0.3
#   rollback_config:
#     parallelism: 1
#     delay: 5s
#     failure_action: pause
#     monitor: 60s
#     max_failure_ratio: 0.3